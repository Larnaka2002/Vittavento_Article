<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Vittavento Article Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
      .inline-form { display: contents; }
    </style>
</head>
<body>
  {% if current_user.is_authenticated %}
    <div class="admin-panel">
      <a href="{{ url_for('admin.index') }}" class="admin-link">üõ† –ê–¥–º–∏–Ω–∫–∞</a>
      <a href="{{ url_for('auth.logout') }}" class="admin-link">‚èè –í—ã—Ö–æ–¥</a>
    </div>
  {% endif %}

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-message {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="container">
    <h1>Vittavento Article Generator</h1>

    <!-- –û–î–ù–ê –æ–±—â–∞—è —Ñ–æ—Ä–º–∞ -->
    <form method="POST" action="{{ url_for('main.generator') }}">
      <div class="code-container">

        <!-- –í–ò–î -->
        <div class="symbol-block group group-1">
          <select class="symbol-select" name="view" id="view-select">
            {% for v in views %}
              <option value="{{ v.id }}" {% if selected_view_id == v.id|string %}selected{% endif %}>{{ v.name }}</option>
            {% endfor %}
            <option value="add_new">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –≤–∏–¥</option>
          </select>
        </div>

        <!-- –ö–ê–¢–ï–ì–û–†–ò–Ø (–≤—Ç–æ—Ä–∞—è –∏ —Ç—Ä–µ—Ç—å—è –±—É–∫–≤—ã –∞—Ä—Ç–∏–∫—É–ª–∞). –§–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ –≤–∏–¥—É. -->
        <div class="symbol-block group-2">
          <select name="category" class="symbol-select" id="category-select">
            {% if categories %}
              {% for category in categories %}
                <option value="{{ category.name }}" data-id="{{ category.id }}" {% if selected_category_name == category.name %}selected{% endif %}>
                  {{ category.name[:2].upper() }}
                </option>
              {% endfor %}
            {% else %}
              <option value="none" disabled selected>–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</option>
            {% endif %}
            <option value="add_new">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
          </select>
        </div>


        <!-- –£–†–û–í–ï–ù–¨ –ò–ï–†–ê–†–•–ò–ò -->
        <!-- –í–´–ë–û–† –£–†–û–í–ù–Ø -->
        <div class="symbol-block group-1">
          <select name="level" class="symbol-select">
            <option value="1" {% if selected_level == '1' %}selected{% endif %}>1</option>
            <option value="2" {% if selected_level == '2' %}selected{% endif %}>2</option>
            <option value="3" {% if selected_level == '3' %}selected{% endif %}>3</option>
            <option value="4" {% if selected_level == '4' or not selected_level %}selected{% endif %}>4</option>
          </select>
        </div>


        <div class="dash">-</div>

        <!-- –ú–û–î–ï–õ–¨ (4-–π –±–ª–æ–∫ –∞—Ä—Ç–∏–∫—É–ª–∞) -->
        <div class="symbol-block double-symbol">
          <select name="model" id="model-select" class="symbol-select">
            <option value="">--</option>
            <option value="add_new">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å</option>
          </select>
        </div>


        <!-- –¶–í–ï–¢ (–ø—è—Ç—ã–π –±–ª–æ–∫ –∞—Ä—Ç–∏–∫—É–ª–∞) -->
        <div class="symbol-block group group-2">
          <select name="color" class="symbol-select" id="color-select">
            {% for color in colors %}
              <option value="{{ color.code }}">{{ color.code }} ‚Äì {{ color.name }}</option>
            {% endfor %}
            <option value="add_new">+ –î–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç</option>
          </select>
        </div>


        <!-- –í–ï–° (–æ–¥–∏–Ω –±–ª–æ–∫, —Ä–µ–∞–≥–∏—Ä—É—é—â–∏–π –Ω–∞ –∫–ª–∏–∫) -->
        <div class="symbol-block group triple-symbol" onclick="toggleWeightInput()" style="position: relative;">
          <span id="weight_display" class="symbol-display">---</span>

          <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–≤–æ–¥–∞ -->
          <input
            type="number"
            step="0.001"
            min="0"
            max="99.999"
            id="weight_input"
            name="weight"
            placeholder="27.330"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                   background-color: white; color: black; font-size: 1.2em;
                   border: none; text-align: center; display: none; border-radius: 6px;"
            onblur="applyWeight()"
          >
        </div>


       <!-- –í–´–ë–û–† –ö–û–ú–ü–û–ù–ï–ù–¢–û–í (2 –∏ 3) -->
        <div class="symbol-block group group-2" onclick="location.href='{{ url_for('main.select_components') }}'" style="cursor: pointer;">
          {{ selected_components_count if selected_components_count is defined else '00' }}
        </div>

        <!-- –í–´–ë–û–† –î–ï–¢–ê–õ–ï–ô (4) -->
        <div class="symbol-block group group-2" onclick="location.href='{{ url_for('main.select_details') }}'" style="cursor: pointer;">
          {{ selected_details_count if selected_details_count is defined else '00' }}
        </div>

        <div class="dash">-</div>
      </div>

      <!-- –û–ü–ò–°–ê–ù–ò–ï -->
      <div class="description-block">
        <label for="article_description">–û–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ç–∏–∫—É–ª–∞</label>
        <textarea id="article_description" name="article_description" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
      </div>

      <!-- –ö–ù–û–ü–ö–ò -->
      <div class="button-container">
        <button type="submit" class="start-button">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨</button>
        <a href="{{ url_for('main.list_articles') }}" class="start-button">–°–ø–∏—Å–æ–∫ –∞—Ä—Ç–∏–∫—É–ª–æ–≤</a>
      </div>

      <!-- –°–ö–†–´–¢–´–ï –ü–û–õ–Ø -->
      <input type="hidden" name="article_code" id="article_code">
      <input type="hidden" name="prefix" id="prefix">
    </form>
  </div>

    <!-- JS: –ü–æ–¥–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –º–æ–¥–µ–ª–µ–π, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Ä—Ç–∏–∫—É–ª–∞ -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {
      const viewSelect = document.getElementById("view-select");
      const categorySelect = document.getElementById("category-select");
      const modelSelect = document.getElementById("model-select");
      const descriptionTextarea = document.getElementById("article_description");

      // --- –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –í–∏–¥–∞ ---
      viewSelect.addEventListener("change", async function () {
        const viewId = this.value;
        categorySelect.innerHTML = "";

        if (viewId === "add_new") {
          window.location.href = "/add_view";
          return;
        }

        try {
          const res = await fetch(`/api/categories/${viewId}`);
          const categories = await res.json();

          if (categories.length === 0) {
            const opt = document.createElement("option");
            opt.text = "–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π";
            opt.disabled = true;
            opt.selected = true;
            categorySelect.add(opt);
          } else {
            categories.forEach(c => {
              const opt = document.createElement("option");
              opt.value = c.name;
              opt.text = c.name.slice(0, 2).toUpperCase();
              opt.dataset.id = c.id;
              categorySelect.add(opt);
            });
          }

          const addNew = document.createElement("option");
          addNew.value = "add_new";
          addNew.text = "+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é";
          categorySelect.add(addNew);
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:", err);
        }
      });

      // --- –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ "–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é" ---
      categorySelect.addEventListener("change", function () {
        if (this.value === "add_new") {
          window.location.href = "/add_category";
        }
      });

      // --- –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –í–∏–¥–∞ –∏–ª–∏ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ---
      async function loadModels() {
        const viewId = viewSelect.value;
        const selectedCategory = categorySelect.selectedOptions[0];
        const categoryId = selectedCategory ? selectedCategory.dataset.id : null;

        modelSelect.innerHTML = "";

        if (!viewId || !categoryId || selectedCategory.value === "add_new") return;

        try {
          const res = await fetch(`/api/models/${viewId}/${categoryId}`);
          const models = await res.json();

          if (models.length === 0) {
            const opt = document.createElement("option");
            opt.text = "–ù–µ—Ç –º–æ–¥–µ–ª–µ–π";
            opt.disabled = true;
            opt.selected = true;
            modelSelect.appendChild(opt);
          } else {
            models.forEach(m => {
              const opt = document.createElement("option");
              opt.value = m.code;
              opt.text = m.code;
              opt.dataset.description = m.description || "";
              modelSelect.appendChild(opt);
            });
          }

          const addNew = document.createElement("option");
          addNew.value = "add_new";
          addNew.text = "+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å";
          modelSelect.appendChild(addNew);

        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π:", err);
        }
      }

      viewSelect.addEventListener("change", loadModels);
      categorySelect.addEventListener("change", loadModels);

      // --- –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ –º–æ–¥–µ–ª–∏ ---
      modelSelect.addEventListener("change", function () {
        const selected = this.selectedOptions[0];
        if (selected && selected.dataset.description && !descriptionTextarea.value) {
          descriptionTextarea.value = selected.dataset.description;
        }

        if (this.value === "add_new") {
          window.location.href = "/add_model";
        }
      });
    });
    </script>

    <!-- JS: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Ä—Ç–∏–∫—É–ª–∞ -->
    <script>
    document.querySelector('form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const symbols = [...document.querySelectorAll('.symbol-select')];
      const rawCode = symbols.map(el => el.value).join('');

      const articleCodeParts = [
        rawCode.slice(0, 4),
        rawCode.slice(4, 11),
        rawCode.slice(11, 15),
        rawCode.slice(15)
      ];

      const partialCode = articleCodeParts.slice(0, 3).join('-');
      let nextPrefix = 1;

      try {
        const response = await fetch('/get_prefix', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ partial_code: partialCode })
        });
        const data = await response.json();
        nextPrefix = data.prefix || 1;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–µ—Ñ–∏–∫—Å–∞:', error);
      }

      articleCodeParts.push(nextPrefix);
      const fullCode = articleCodeParts.join('-');

      document.getElementById('article_code').value = fullCode;
      document.getElementById('prefix').value = nextPrefix;

      const descField = document.getElementById('article_description');
      if (!descField.value) {
        descField.value = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞—Ä—Ç–∏–∫—É–ª';
      }

      e.target.submit();
    });
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
      const colorSelect = document.getElementById("color-select");
      if (colorSelect) {
        colorSelect.addEventListener("change", function () {
          if (this.value === "add_new") {
            window.location.href = "/add_color";
          }
        });
      }
    });
    </script>

    <script>
      const input = document.getElementById('weight_input');
      const display = document.getElementById('weight_display');

      function toggleWeightInput() {
        input.style.display = 'block';
        input.focus();
      }

      function applyWeight() {
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
          const rounded = Math.round(value * 10); // –Ω–∞–ø—Ä–∏–º–µ—Ä: 27.330 ‚Üí 273.3 ‚Üí 273
          display.textContent = rounded.toString().padStart(3, '0');
        } else {
          display.textContent = '---';
        }
        input.style.display = 'none';
      }
    </script>






</body>
</html>
